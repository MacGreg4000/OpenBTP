'use client'

import React, { createContext, useContext, useEffect, useMemo, useState, useCallback } from 'react'

export type Lang = 'fr' | 'en' | 'pt' | 'ro'

const STRINGS: Record<Lang, Record<string, string>> = {
  fr: {
    portal_title_ouvrier: "Portail Ouvrier Interne",
    portal_title_sst: "Portail Sous-traitant",
    enter_pin: "Entrez votre code PIN pour accéder à votre espace.",
    pin_placeholder: "Code PIN (6 chiffres)",
    connect: "Se connecter",
    receptions: "Réceptions",
    sav_tickets: "Tickets SAV",
    new_bon_regie: "Nouveau bon régie",
    my_planning: "Mon planning",
    back: "Retour",
    search: "Rechercher",
    loading: "Chargement...",
    error: "Erreur",
    submit_metre: "Soumettre un métré",
    // Nouveau métré
    overlay_landscape_title: "Pour une meilleure visibilité",
    overlay_landscape_subtitle: "Tournez votre téléphone en mode paysage.",
    overlay_try_landscape: "Tenter de basculer en paysage",
    create_free_metre: "Créer un métré sans commande (chantier libre)",
    chantier_label: "Chantier",
    select_placeholder: "Sélectionner…",
    free_chantier_name: "Nom du chantier libre",
    add_supplement: "Ajouter un supplément",
    comment_label: "Commentaire",
    attach_photos: "Joindre des photos (optionnel)",
    estimated_total: "Total estimé",
    submit: "Soumettre",
    sending: "Envoi...",
    
    table_description: "Description",
    table_unit: "Unité",
    table_unit_price: "PU",
    table_quantity: "Quantité",
    table_total: "Total",
    submit_error: "Soumission impossible. Vérifiez vos données.",
    // Portail accueil
    photos_send: "Envoyer des photos",
    photos_subtitle: "Upload de photos de chantier",
    my_submitted_metres: "Mes métrés envoyés",
    none: "Aucun métré",
    logout: "Déconnexion",
    remarks: "remarques",
    finalized: "Finalisée",
    in_progress: "En cours",
    photos_title: "Upload de Photos",
    back_to_portal: "Retour au portail",
    photos_form_title: "Ajouter des photos",
    photos_form_subtitle: "Sélectionnez un chantier et vos photos",
    chantier_required: "Chantier *",
    chantier_select_placeholder: "Sélectionnez un chantier",
    photos_label: "Photos * (max 20)",
    click_to_select_photos: "Cliquez pour sélectionner des photos",
    or_drag_drop: "ou glissez-déposez vos photos ici",
    selected_photos_count: "photo(s) sélectionnée(s)",
    preview_label: "Aperçu",
    description_optional: "Description (optionnel)",
    description_placeholder: "Ajoutez une description ou des commentaires...",
    uploading: "Upload en cours...",
    send_photos: "Envoyer les photos",
    instructions: "Instructions",
    instruction_select_site: "• Sélectionnez le chantier concerné dans la liste",
    instruction_up_to_20: "• Ajoutez jusqu'à 20 photos maximum par envoi",
    instruction_compressed: "• Les photos sont automatiquement compressées",
    instruction_notification: "• Une notification sera envoyée à l'équipe",
    instruction_visible: "• Les photos sont immédiatement visibles dans l'application",
    today: "Aujourd'hui",
    no_activity_today: "Aucune activité enregistrée",
    day_in_progress: "Journée en cours",
    day_validated: "Journée validée ✅",
    new_activity: "Nouvelle activité",
    my_journal: "Mon Journal",
    modal_edit_entry: "Modifier l'entrée",
    modal_new_activity: "Nouvelle activité",
    date: "Date",
    full_day: "Journée entière (8h-17h)",
    start_time: "Heure début",
    end_time: "Heure fin",
    work_place: "Lieu de travail",
    select_site: "Sélectionner un chantier",
    free_site: "Chantier libre / Déplacement",
    free_place: "Lieu libre",
    free_place_placeholder: "Déplacement, formation, bureau, etc.",
    description: "Description",
    description_placeholder_journal: "Décrivez ce que vous avez fait...",
    cancel: "Annuler",
    saving: "Sauvegarde...",
    save: "Enregistrer",
    confirm_delete: "Êtes-vous sûr de vouloir supprimer cette entrée ?",
    details: "Voir les détails",
  },
  en: {
    portal_title_ouvrier: "Worker Portal",
    portal_title_sst: "Subcontractor Portal",
    enter_pin: "Enter your PIN code to access your space.",
    pin_placeholder: "PIN code (6 digits)",
    connect: "Sign in",
    receptions: "Receptions",
    sav_tickets: "Service tickets",
    new_bon_regie: "New work order",
    my_planning: "My schedule",
    back: "Back",
    search: "Search",
    loading: "Loading...",
    error: "Error",
    submit_metre: "Submit a measurement",
    overlay_landscape_title: "For better visibility",
    overlay_landscape_subtitle: "Rotate your phone to landscape mode.",
    overlay_try_landscape: "Try switching to landscape",
    create_free_metre: "Create a measurement without order (free job)",
    chantier_label: "Project",
    select_placeholder: "Select…",
    free_chantier_name: "Free job name",
    add_supplement: "Add supplement",
    comment_label: "Comment",
    attach_photos: "Attach photos (optional)",
    estimated_total: "Estimated total",
    submit: "Submit",
    sending: "Sending...",
    
    table_description: "Description",
    table_unit: "Unit",
    table_unit_price: "Unit price",
    table_quantity: "Quantity",
    table_total: "Total",
    submit_error: "Submission failed. Please check your data.",
    photos_send: "Send photos",
    photos_subtitle: "Upload site photos",
    my_submitted_metres: "My submitted measurements",
    none: "No measurement",
    logout: "Logout",
    remarks: "remarks",
    finalized: "Finalized",
    in_progress: "In progress",
    photos_title: "Photo Upload",
    back_to_portal: "Back to portal",
    photos_form_title: "Add photos",
    photos_form_subtitle: "Select a project and your photos",
    chantier_required: "Project *",
    chantier_select_placeholder: "Select a project",
    photos_label: "Photos * (max 20)",
    click_to_select_photos: "Click to select photos",
    or_drag_drop: "or drag and drop your photos here",
    selected_photos_count: "photo(s) selected",
    preview_label: "Preview",
    description_optional: "Description (optional)",
    description_placeholder: "Add a description or comments...",
    uploading: "Uploading...",
    send_photos: "Send photos",
    instructions: "Instructions",
    instruction_select_site: "• Select the project from the list",
    instruction_up_to_20: "• Add up to 20 photos per submission",
    instruction_compressed: "• Photos are automatically compressed",
    instruction_notification: "• A notification will be sent to the team",
    instruction_visible: "• Photos are immediately visible in the app",
    today: "Today",
    no_activity_today: "No activity recorded",
    day_in_progress: "Day in progress",
    day_validated: "Day validated ✅",
    new_activity: "New activity",
    my_journal: "My Journal",
    modal_edit_entry: "Edit entry",
    modal_new_activity: "New activity",
    date: "Date",
    full_day: "Full day (8am-5pm)",
    start_time: "Start time",
    end_time: "End time",
    work_place: "Workplace",
    select_site: "Select a site",
    free_site: "Free site / Travel",
    free_place: "Free place",
    free_place_placeholder: "Travel, training, office, etc.",
    description: "Description",
    description_placeholder_journal: "Describe what you did...",
    cancel: "Cancel",
    saving: "Saving...",
    save: "Save",
    confirm_delete: "Are you sure you want to delete this entry?",
    details: "View details",
  },
  pt: {
    portal_title_ouvrier: "Portal do Colaborador",
    portal_title_sst: "Portal do Subempreiteiro",
    enter_pin: "Insira o seu PIN para aceder ao espaço.",
    pin_placeholder: "Código PIN (6 dígitos)",
    connect: "Entrar",
    receptions: "Receções",
    sav_tickets: "Tickets de assistência",
    new_bon_regie: "Nova ordem de serviço",
    my_planning: "O meu planeamento",
    back: "Voltar",
    search: "Pesquisar",
    loading: "A carregar...",
    error: "Erro",
    submit_metre: "Submeter um medição",
    overlay_landscape_title: "Para melhor visibilidade",
    overlay_landscape_subtitle: "Vire o telefone para o modo horizontal.",
    overlay_try_landscape: "Tentar alternar para horizontal",
    create_free_metre: "Criar medição sem encomenda (intervenção livre)",
    chantier_label: "Obra",
    select_placeholder: "Selecionar…",
    free_chantier_name: "Nome da intervenção livre",
    add_supplement: "Adicionar suplemento",
    comment_label: "Comentário",
    attach_photos: "Anexar fotos (opcional)",
    estimated_total: "Total estimado",
    submit: "Submeter",
    sending: "A enviar...",
    
    table_description: "Descrição",
    table_unit: "Unidade",
    table_unit_price: "PU",
    table_quantity: "Quantidade",
    table_total: "Total",
    submit_error: "Submissão falhou. Verifique os dados.",
    photos_send: "Enviar fotos",
    photos_subtitle: "Upload de fotos da obra",
    my_submitted_metres: "As minhas medições enviadas",
    none: "Nenhuma medição",
    logout: "Terminar sessão",
    remarks: "observações",
    finalized: "Finalizada",
    in_progress: "Em curso",
    photos_title: "Upload de Fotos",
    back_to_portal: "Voltar ao portal",
    photos_form_title: "Adicionar fotos",
    photos_form_subtitle: "Selecione a obra e as suas fotos",
    chantier_required: "Obra *",
    chantier_select_placeholder: "Selecione uma obra",
    photos_label: "Fotos * (máx 20)",
    click_to_select_photos: "Clique para selecionar as fotos",
    or_drag_drop: "ou arraste e largue as fotos aqui",
    selected_photos_count: "foto(s) selecionada(s)",
    preview_label: "Pré-visualização",
    description_optional: "Descrição (opcional)",
    description_placeholder: "Adicione uma descrição ou comentários...",
    uploading: "A enviar...",
    send_photos: "Enviar fotos",
    instructions: "Instruções",
    instruction_select_site: "• Selecione a obra na lista",
    instruction_up_to_20: "• Adicione até 20 fotos por envio",
    instruction_compressed: "• As fotos são comprimidas automaticamente",
    instruction_notification: "• Será enviada uma notificação à equipa",
    instruction_visible: "• As fotos ficam visíveis imediatamente na aplicação",
    today: "Hoje",
    no_activity_today: "Nenhuma atividade registada",
    day_in_progress: "Dia em curso",
    day_validated: "Dia validado ✅",
    new_activity: "Nova atividade",
    my_journal: "O meu Jornal",
    modal_edit_entry: "Editar entrada",
    modal_new_activity: "Nova atividade",
    date: "Data",
    full_day: "Dia inteiro (08:00-17:00)",
    start_time: "Hora início",
    end_time: "Hora fim",
    work_place: "Local de trabalho",
    select_site: "Selecionar uma obra",
    free_site: "Obra livre / Deslocação",
    free_place: "Local livre",
    free_place_placeholder: "Deslocação, formação, escritório, etc.",
    description: "Descrição",
    description_placeholder_journal: "Descreva o que fez...",
    cancel: "Cancelar",
    saving: "A guardar...",
    save: "Guardar",
    confirm_delete: "Tem a certeza de que deseja eliminar esta entrada?",
    details: "Ver detalhes",
  },
  ro: {
    portal_title_ouvrier: "Portal lucrător intern",
    portal_title_sst: "Portal subcontractant",
    enter_pin: "Introduceți codul PIN pentru a accesa spațiul dvs.",
    pin_placeholder: "Cod PIN (6 cifre)",
    connect: "Conectare",
    receptions: "Recepții",
    sav_tickets: "Tichete SAV",
    new_bon_regie: "Ordin de lucru nou",
    my_planning: "Programul meu",
    back: "Înapoi",
    search: "Căutare",
    loading: "Se încarcă...",
    error: "Eroare",
    submit_metre: "Trimite un metraj",
    overlay_landscape_title: "Pentru o vizibilitate mai bună",
    overlay_landscape_subtitle: "Rotiți telefonul în modul peisaj.",
    overlay_try_landscape: "Încercați să comutați pe peisaj",
    create_free_metre: "Creați metraj fără comandă (lucrare liberă)",
    chantier_label: "Șantier",
    select_placeholder: "Selectați…",
    free_chantier_name: "Numele lucrării libere",
    add_supplement: "Adaugă supliment",
    comment_label: "Comentariu",
    attach_photos: "Atașați fotografii (opțional)",
    estimated_total: "Total estimat",
    submit: "Trimite",
    sending: "Se trimite...",
    
    table_description: "Descriere",
    table_unit: "Unitate",
    table_unit_price: "PU",
    table_quantity: "Cantitate",
    table_total: "Total",
    submit_error: "Trimitere eșuată. Verificați datele.",
    photos_send: "Trimite fotografii",
    photos_subtitle: "Încărcare fotografii șantier",
    my_submitted_metres: "Metrajele mele trimise",
    none: "Niciun metraj",
    logout: "Deconectare",
    remarks: "observații",
    finalized: "Finalizată",
    in_progress: "În curs",
    photos_title: "Încărcare fotografii",
    back_to_portal: "Înapoi la portal",
    photos_form_title: "Adaugă fotografii",
    photos_form_subtitle: "Selectează șantierul și fotografiile",
    chantier_required: "Șantier *",
    chantier_select_placeholder: "Selectează un șantier",
    photos_label: "Fotografii * (max 20)",
    click_to_select_photos: "Click pentru a selecta fotografii",
    or_drag_drop: "sau trage și plasează fotografiile aici",
    selected_photos_count: "fotografie(i) selectată(e)",
    preview_label: "Previzualizare",
    description_optional: "Descriere (opțional)",
    description_placeholder: "Adăugați o descriere sau comentarii...",
    uploading: "Se încarcă...",
    send_photos: "Trimite fotografii",
    instructions: "Instrucțiuni",
    instruction_select_site: "• Selectați șantierul din listă",
    instruction_up_to_20: "• Adăugați până la 20 de fotografii per trimitere",
    instruction_compressed: "• Fotografiile sunt comprimate automat",
    instruction_notification: "• Se va trimite o notificare echipei",
    instruction_visible: "• Fotografiile sunt vizibile imediat în aplicație",
    today: "Astăzi",
    no_activity_today: "Nicio activitate înregistrată",
    day_in_progress: "Zi în curs",
    day_validated: "Zi validată ✅",
    new_activity: "Activitate nouă",
    my_journal: "Jurnalul meu",
    modal_edit_entry: "Editează înregistrarea",
    modal_new_activity: "Activitate nouă",
    date: "Data",
    full_day: "Zi întreagă (08:00-17:00)",
    start_time: "Ora început",
    end_time: "Ora sfârșit",
    work_place: "Locul de muncă",
    select_site: "Selectați un șantier",
    free_site: "Șantier liber / Deplasare",
    free_place: "Loc liber",
    free_place_placeholder: "Deplasare, formare, birou, etc.",
    description: "Descriere",
    description_placeholder_journal: "Descrieți ce ați făcut...",
    cancel: "Anulare",
    saving: "Se salvează...",
    save: "Salvează",
    confirm_delete: "Sigur doriți să ștergeți această înregistrare?",
    details: "Vezi detalii",
  },
}

type I18nContextType = {
  lang: Lang
  setLang: (l: Lang) => void
  t: (key: string) => string
}

const I18nContext = createContext<I18nContextType | undefined>(undefined)

export function PortalI18nProvider({ children }: { children: React.ReactNode }) {
  const [lang, setLangState] = useState<Lang>('fr')

  useEffect(() => {
    const stored = typeof window !== 'undefined' ? (localStorage.getItem('portalLang') as Lang | null) : null
    if (stored && STRINGS[stored]) setLangState(stored)
  }, [])

  const setLang = (l: Lang) => {
    setLangState(l)
    try {
      localStorage.setItem('portalLang', l)
      document.cookie = `portalLang=${l}; path=/; max-age=${60 * 60 * 24 * 365}`
    } catch {}
  }

  const t = useCallback((key: string) => STRINGS[lang][key] || key, [lang])

  const value = useMemo(() => ({ lang, setLang, t }), [lang, t])

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>
}

export function usePortalI18n() {
  const ctx = useContext(I18nContext)
  if (!ctx) throw new Error('usePortalI18n must be used within PortalI18nProvider')
  return ctx
}

